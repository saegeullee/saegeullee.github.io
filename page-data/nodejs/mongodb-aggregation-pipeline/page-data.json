{"componentChunkName":"component---src-templates-post-template-js","path":"/nodejs/mongodb-aggregation-pipeline","result":{"data":{"markdownRemark":{"id":"903fdbc3-e8bd-5831-bc2b-22b05441fe33","html":"<blockquote>\n<p><strong><a href=\"https://www.udemy.com/course/nodejs-express-mongodb-bootcamp/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">유데미 NODE.JS</a></strong> 수업을 듣고 정리한 내용입니다.</p>\n</blockquote>\n<h1 id=\"목차\"><a href=\"#%EB%AA%A9%EC%B0%A8\" aria-label=\"목차 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>목차</h1>\n<ul>\n<li><a href=\"#%EB%AA%BD%EA%B3%A0db-aggregation-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8\">몽고DB aggregation 파이프라인</a></li>\n<li><a href=\"#matching-and-grouping\">Matching and Grouping</a></li>\n<li><a href=\"#unwinding-and-projecting\">Unwinding and Projecting</a></li>\n</ul>\n<h2 id=\"몽고db-aggregation-파이프라인\"><a href=\"#%EB%AA%BD%EA%B3%A0db-aggregation-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8\" aria-label=\"몽고db aggregation 파이프라인 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>몽고db aggregation 파이프라인</h2>\n<p>몽고DB aggregation 파이프라인은 강력한 MongoDB 프레임워크로 데이터를 aggregate(종합)할 때 유용하게 쓰인다. 특정 컬렉션의 모든 도큐먼트를 어떤 파이프라인을 통과하게 만들어 aggregate(종합)된 결과를 만들 때 사용할 수 있다. 예를들어 특정 컬렉션 모든 도큐먼트의 특정 프로퍼티의 평균을 구하거나 최소값, 최대값 등을 구할 수 있다.</p>\n<p><strong><a href=\"https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">몽고DB documentation pipeline stages</a></strong> 참고</p>\n<h2 id=\"matching-and-grouping\"><a href=\"#matching-and-grouping\" aria-label=\"matching and grouping permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>matching and grouping</h2>\n<p>파이프라인은 다음과 같이 구성한다. <code class=\"language-text\">Tour.aggregate</code> 메서드의 인자에 파이프라인 stage 객체를 배열로 넣는다. 그럼 <code class=\"language-text\">Tour</code> 컬렉션의 모든 도큐먼트가 파이프라인 stage를 순서대로 통과한다. 아래의 예시에서 첫번째 stage는 <code class=\"language-text\">$match</code>이다. 이는 Tour 컬렉션의 모든 도큐먼트 중에서 <code class=\"language-text\">ratingsAverage</code>가 4.5 이상인 도큐먼트만을 필터링한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">//controllers/tourControllers.js</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getTourStats</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> stats <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Tour<span class=\"token punctuation\">.</span><span class=\"token function\">aggregate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      $match<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> ratingsAverage<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> $gte<span class=\"token punctuation\">:</span> <span class=\"token number\">4.5</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      $group<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//make spell uppercase</span>\n        _id<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> $toUpper<span class=\"token punctuation\">:</span> <span class=\"token string\">'$difficulty'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        numTours<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> $sum<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        numRatings<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> $sum<span class=\"token punctuation\">:</span> <span class=\"token string\">'$ratingsQuantity'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        avgRating<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> $avg<span class=\"token punctuation\">:</span> <span class=\"token string\">'$ratingsAverage'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        avgPrice<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> $avg<span class=\"token punctuation\">:</span> <span class=\"token string\">'$price'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        minPrice<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> $min<span class=\"token punctuation\">:</span> <span class=\"token string\">'$price'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        maxPrice<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> $max<span class=\"token punctuation\">:</span> <span class=\"token string\">'$price'</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      $sort<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> avgPrice<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    status<span class=\"token punctuation\">:</span> <span class=\"token string\">'success'</span><span class=\"token punctuation\">,</span>\n    data<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      stats\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>우선 위의 코드를 실행하는 엔드포인트로 요청을 보냈을때의 응답 결과를 보면 다음과 같다. 두번째 stage인 <code class=\"language-text\">$group</code>을 보자. 이 stage는 프로퍼티가 많기 때문에 하나씩 나눠서 설명을 해보면 다음과 같다.<br></p>\n<ol>\n<li><code class=\"language-text\">_id: { $toUpper: &#39;$difficulty&#39; }</code><br>\n<code class=\"language-text\">_id</code>는 도큐먼트를 묶는 기준이 된다. Tour 스키마에서 <code class=\"language-text\">difficulty</code> 필드는 하단에 첨부해놓았다. <code class=\"language-text\">difficulty</code>는 enum 필드로 정의되어 반드시 <code class=\"language-text\">[&#39;easy&#39;, &#39;medium&#39;, &#39;difficult&#39;]</code> 이 셋중의 하나의 값을 가져야 한다. 즉 Tour 컬렉션의 모든 도큐먼트의 <code class=\"language-text\">difficulty</code> 필드는 이 셋 중 하나의 값을 가진다. 여기서는 이 필드를 기준으로 도큐먼트들을 나눠 총 3개의 그룹으로 만든것이다. <code class=\"language-text\">$toUpper</code> 은 <code class=\"language-text\">diffculty</code> 필드의 값을 대문자로 바꿔서 나타낸다. 아래의 결과를 보면 <code class=\"language-text\">EASY</code>, <code class=\"language-text\">DIFFICULT</code>, <code class=\"language-text\">MEDIUM</code> 으로 대문자로 변환되었다.</li>\n<li><code class=\"language-text\">numTours: { $sum: 1 }</code><br>\n<code class=\"language-text\">numTours</code>는 해당 그룹의 도큐먼트가 몇 개인지를 나타낸다. aggregate 메서드가 동작하면서 도큐먼트들을 그룹으로 나눌때 해당 그룹의 도큐먼트가 하나씩 추가될 때 마다 1을 더하여 최종적으로 해당 그룹에 총 몇개의 도큐먼트가 있는지를 세는 것이다.</li>\n<li>그 외 <code class=\"language-text\">numRatings</code> ~ <code class=\"language-text\">maxPrice</code> <br>\n그 외의 프로퍼티는 이름에서 알 수 있듯이 해당 그룹의 평균값과 최댓값, 최솟값을 뽑아준다.</li>\n</ol>\n<p>마지막 stage인 <code class=\"language-text\">$sort</code>에서는 결과물을 정렬하는 기준을 정할 수 있다. 아래의 결과물을 보면 <code class=\"language-text\">avgPrice</code>가 낮은 순으로 정렬된 것을 확인해 볼 수 있다. <code class=\"language-text\">avgPrice</code>를 높은 순으로 정렬하고 싶다면 -1을 값으로 주면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"stats\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"EASY\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"numTours\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"numRatings\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">159</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"avgRating\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4.675</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"avgPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1272</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"minPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">397</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"maxPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1997</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"DIFFICULT\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"numTours\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"numRatings\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">41</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"avgRating\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4.6</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"avgPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1997</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"minPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">997</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"maxPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2997</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"MEDIUM\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"numTours\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"numRatings\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">126</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"avgRating\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4.76</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"avgPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2197</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"minPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">497</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"maxPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2997</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">//Tour 스키마 중 difficulty 필드</span>\ndifficulty<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n  type<span class=\"token punctuation\">:</span> String<span class=\"token punctuation\">,</span>\n  required<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'A tour must have a difficulty'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">enum</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    values<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'easy'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'medium'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'difficult'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">:</span> <span class=\"token string\">'Difficulty is either: easy, medium, difficult'</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p><code class=\"language-text\">stage</code>는 반복하여 사용할 수 있다. 위의 aggregate 파이프라인에 다음의 stage를 네번째 stage로 추가하면 <code class=\"language-text\">_id</code>가 ‘EASY`인 그룹은 응답에서 제외된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  $match<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    _id<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      $ne<span class=\"token punctuation\">:</span> <span class=\"token string\">'EASY'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"stats\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"DIFFICULT\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"numTours\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"numRatings\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">41</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"avgRating\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4.6</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"avgPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1997</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"minPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">997</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"maxPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2997</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"MEDIUM\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"numTours\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"numRatings\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">126</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"avgRating\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4.76</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"avgPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2197</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"minPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">497</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"maxPrice\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2997</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"unwinding-and-projecting\"><a href=\"#unwinding-and-projecting\" aria-label=\"unwinding and projecting permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>unwinding and projecting</h2>\n<p><code class=\"language-text\">$unwind</code>는 도큐먼트에서 배열을 값으로 가지고 있는 필드를 풀어 배열의 각 엘리먼트를 하나씩 가지고 있는 여러개의 도큐먼트로 만들어준다. 이건 결과를 보면 이해하기 수월하다. 하나의 도큐먼트를 쿼리한 결과가 다음과 같은 경우를 보자. <code class=\"language-text\">hobbies</code> 필드의 값은 배열로 이루어져 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n  &quot;name&quot; : &quot;louies&quot;,\n  &quot;age: : 29,\n  &quot;hobbies&quot; : [&quot;soccer&quot;, &quot;tennis&quot;, &quot;programming&quot;]\n}</code></pre></div>\n<p>이때 이 도큐먼트를 mongodb aggregate 메서드에서 <code class=\"language-text\">$unwind</code> stage를 통과시키면 다음과 같이 배열 3개의 엘리먼트 각각을 가지고 있는 3개의 도큐먼트로 풀어낸 결과값을 얻을 수 있다. 이런 기능이 왜 필요한가 싶을 수 있지만 어플리케이션에 따라 매우 유용하게 사용할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n  &quot;name&quot; : &quot;louies&quot;,\n  &quot;age: : 29,\n  &quot;hobbies&quot; : &quot;soccer&quot;\n},\n{\n  &quot;name&quot; : &quot;louies&quot;,\n  &quot;age: : 29,\n  &quot;hobbies&quot; : &quot;tennis&quot;\n},\n{\n  &quot;name&quot; : &quot;louies&quot;,\n  &quot;age: : 29,\n  &quot;hobbies&quot; : &quot;programming&quot;\n}</code></pre></div>\n<p>이 수업에서는 투어 프로그램을 판매하는 플랫폼 서비스를 예시로 든다. <code class=\"language-text\">$unwind</code> 기능으로 플랫폼에 있는 모든 투어 프로그램을 종합하여 특정 년도에 가장 바쁜 달이 언제인지를 알아낼 수 있다. 우선 투어 도큐먼트를 살펴보자. 지면 제약상 설명에 꼭 필요한 필드만 넣었다.\n이 투어 도큐먼트의 <code class=\"language-text\">startDates</code> 필드는 투어 프로그램의 시작 날짜들을 배열로 가지고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n<span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"results\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">11</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"tours\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"ratingsAverage\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4.7</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"startDates\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"2021-03-23T01:00:00.000Z\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"2021-10-25T01:00:00.000Z\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"2022-01-30T01:00:00.000Z\"</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"5dd1531c7bfcc407cb54f2ed\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"The Star Gazer 2\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"price\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2997</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"description\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Ut enim ad minim veniam\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>만약 수많은 투어 도큐먼트를 종합하여 특정 년도에 가장 많은 투어가 시작되는 달을 구하려면 어떻게 해야 할까? 결론부터 보자면 다음과 같이 <code class=\"language-text\">aggregate stage</code>를 구성하여 결과를 얻을 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getMonthlyPlan</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//어떤 년도의 가장 바쁜달을 구하고 싶은지를 받는다. ex) 2021</span>\n    <span class=\"token keyword\">const</span> year <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>year <span class=\"token operator\">*</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> plan <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Tour<span class=\"token punctuation\">.</span><span class=\"token function\">aggregate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n      <span class=\"token comment\">//투어 도큐먼트의 startDates 필드를 unwind한다.</span>\n      <span class=\"token punctuation\">{</span>\n        $unwind<span class=\"token punctuation\">:</span> <span class=\"token string\">'$startDates'</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// 2021년도에 시작하는 투어만 필터링한다.</span>\n      <span class=\"token punctuation\">{</span>\n        $match<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          startDates<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            $gte<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>year<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-01-01</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            $lte<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>year<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-12-31</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// 같은 달에 시작하는 투어들을 그룹으로 묶는다.</span>\n      <span class=\"token punctuation\">{</span>\n        $group<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          _id<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> $month<span class=\"token punctuation\">:</span> <span class=\"token string\">'$startDates'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token comment\">// 한 그룹에 총 몇개의 투어가 있는지를 얻어온다.</span>\n          numTourStarts<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> $sum<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token comment\">// 각 투어의 이름을 가진 배열을 얻어온다.</span>\n          tours<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> $push<span class=\"token punctuation\">:</span> <span class=\"token string\">'$name'</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">//결과 값에 month라는 필드를 추가하여 해당 달을 표시한다.</span>\n      <span class=\"token punctuation\">{</span>\n        $addFields<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> month<span class=\"token punctuation\">:</span> <span class=\"token string\">'$_id'</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">//바로 위에서 해당 달을 표시하기 위한 필드 month를 추가했기 때문에 _id는 결과에서 제외한다.</span>\n      <span class=\"token punctuation\">{</span>\n        $project<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          _id<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// numTourStarts가 높은 순서대로 정렬하여 결과를 가져온다.</span>\n      <span class=\"token punctuation\">{</span>\n        $sort<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> numTourStarts<span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// 한 년도에 1월~12월까지 12개의 달이 있으므로 결과값의 수는 12개로 제한한다.</span>\n      <span class=\"token punctuation\">{</span>\n        $limit<span class=\"token punctuation\">:</span> <span class=\"token number\">12</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위의 컨트롤러 메서드에 보낸 요청에 대한 응답은 다음과 같이 구성된다. 아래의 결과를 보면 2021년 1월~12월중에 투어 프로그램이 4개가 시작하는 달인 3월과 10월이 가장 바쁜 달임을 알 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"plan\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"numTourStarts\"</span><span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"tours\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"The City Wanderer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The Star Gazer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The Star Gazer 2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The Star Gazer 3\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"month\"</span><span class=\"token operator\">:</span> <span class=\"token number\">3</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"numTourStarts\"</span><span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"tours\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"The Forest Hiker\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The Star Gazer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The Star Gazer 2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The Star Gazer 3\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"month\"</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"numTourStarts\"</span><span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"tours\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"The Forest Hiker\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The Sea Explorer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The Sports Lover\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"month\"</span><span class=\"token operator\">:</span> <span class=\"token number\">7</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"numTourStarts\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"tours\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"The Wine Taster\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The Sports Lover\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"month\"</span><span class=\"token operator\">:</span> <span class=\"token number\">9</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"numTourStarts\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"tours\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"The Sea Explorer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The Park Camper\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"month\"</span><span class=\"token operator\">:</span> <span class=\"token number\">8</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"numTourStarts\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"tours\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"The Forest Hiker\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The Wine Taster\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"month\"</span><span class=\"token operator\">:</span> <span class=\"token number\">4</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"numTourStarts\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"tours\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"The Sea Explorer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The City Wanderer\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"month\"</span><span class=\"token operator\">:</span> <span class=\"token number\">6</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"numTourStarts\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"tours\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"The Wine Taster\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"month\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"numTourStarts\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"tours\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"The Northern Lights\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"month\"</span><span class=\"token operator\">:</span> <span class=\"token number\">12</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"numTourStarts\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"tours\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"The City Wanderer\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"month\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","fields":{"slug":"/nodejs/mongodb-aggregation-pipeline","tagSlugs":["/tag/nodejs/","/tag/mongodb/"]},"frontmatter":{"date":"2019-12-14T23:00:37.121Z","description":"몽고DB aggregation 파이프라인은 강력한 MongoDB 프레임워크로 데이터를 aggregate(종합)할 때 유용하게 쓰인다. 특정 컬렉션의 모든 도큐먼트를 어떤 파이프라인을 통과하게 만들어 종합(aggregate)된 결과를 만들 때 사용할 수 있다...","tags":["nodejs","mongodb"],"title":"몽고DB aggregation 파이프라인","socialImage":"/media/image-2.jpg"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/nodejs/mongodb-aggregation-pipeline"}}}
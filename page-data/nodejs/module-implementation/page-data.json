{"componentChunkName":"component---src-templates-post-template-js","path":"/nodejs/module-implementation","result":{"data":{"markdownRemark":{"id":"20bf6fa8-1b58-54c8-b231-da9272ab21ab","html":"<blockquote>\n<p><strong><a href=\"https://www.udemy.com/course/advanced-node-for-developers/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">NodeJS: Advanced Concepts</a></strong> 수업을 듣고 정리한 내용입니다.</p>\n</blockquote>\n<p>Nodejs 서버를 만들 때 <code class=\"language-text\">crypto</code> nodejs 라이브러리의 <code class=\"language-text\">pbkdf2</code> 함수를 실행시키면 nodejs 내부적으로 어떤 일이 일어나는지를 정리해본다. 참고로 <code class=\"language-text\">pbkdf2</code> 함수는 비밀번호를 암호화하여 해시값을 리턴하는 해시 함수이다.</p>\n<ul>\n<li><strong><a href=\"https://saegeullee.github.io/nodejs/how-nodejs-works\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">NodeJS가 작동하는 방법</a></strong> 참고</li>\n</ul>\n<p><strong><a href=\"https://github.com/nodejs/node\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">nodejs 프로젝트 깃헙</a></strong>에서 nodejs 프로젝트의 폴더구조를 보면 <code class=\"language-text\">lib</code> 폴더와 <code class=\"language-text\">src</code> 폴더가 있다. <code class=\"language-text\">lib</code> 폴더에는 nodejs 어플리케이션을 만들 때 <code class=\"language-text\">require</code>하는 자바스크립트 코드로 정의된 모든 모듈과 함수가 포함된다. 즉 nodejs 프로젝트에서 자바스크립트로 작성된 모든 파일들이 <code class=\"language-text\">lib</code> 폴더에 있다.</p>\n<p><code class=\"language-text\">src</code>폴더에는 위의 자바스크립트 코드로 정의된 모든 모듈과 함수들이 C++로 구현되어 있다. Nodejs 어플리케이션에서 <code class=\"language-text\">pbkdf2</code> 함수가 실행되면 궁극적으로는 이에 해당하는 C++ 코드가 실행된다.</p>\n<p>nodejs 프로젝트에 정의된 <strong><a href=\"https://github.com/nodejs/node/blob/master/lib/internal/crypto/pbkdf2.js\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">pbkdf2 함수</a></strong>를 보면 다음과 같다. 이 함수의 맨 끝부분에서 호출되는 함수를 보면 <code class=\"language-text\">_pbkdf2</code> 함수가 있다. <code class=\"language-text\">_pbkdf2</code> 함수는 이 자바스크립트 파일의 상단에서 <code class=\"language-text\">internalBinding</code>되어 이 자바스크립트 파일에서 호출할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> Buffer <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'buffer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> pbkdf2<span class=\"token punctuation\">:</span> _pbkdf2 <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">internalBinding</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crypto'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// MORE REQUIREs...</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">pbkdf2</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">password<span class=\"token punctuation\">,</span> salt<span class=\"token punctuation\">,</span> iterations<span class=\"token punctuation\">,</span> keylen<span class=\"token punctuation\">,</span> digest<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> digest <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    callback <span class=\"token operator\">=</span> digest<span class=\"token punctuation\">;</span>\n    digest <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> password<span class=\"token punctuation\">,</span> salt<span class=\"token punctuation\">,</span> iterations<span class=\"token punctuation\">,</span> keylen<span class=\"token punctuation\">,</span> digest <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">check</span><span class=\"token punctuation\">(</span>\n    password<span class=\"token punctuation\">,</span>\n    salt<span class=\"token punctuation\">,</span>\n    iterations<span class=\"token punctuation\">,</span>\n    keylen<span class=\"token punctuation\">,</span>\n    digest\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">//ERROR CHECKING AND DO MORE STUFF...</span>\n\n  <span class=\"token function\">handleError</span><span class=\"token punctuation\">(</span><span class=\"token function\">_pbkdf2</span><span class=\"token punctuation\">(</span>keybuf<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> salt<span class=\"token punctuation\">,</span> iterations<span class=\"token punctuation\">,</span> digest<span class=\"token punctuation\">,</span> wrap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> digest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>최종적으로 실행이 되는 이 함수 <strong><a href=\"https://github.com/nodejs/node/blob/master/src/node_crypto.cc#L6339\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">_pbkdf2 함수</a></strong> 는 C++ 함수이다. 바인딩을 통해 자바스크립트 코드와 C++ 코드가 연결된 것이다. 즉 nodejs 서버를 만들 때 프로그래머가 nodejs 모듈 함수(자바스크립트)를 사용하면 내부적으로는 이에 해당하는 C++ 코드가 실행된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">inline</span> <span class=\"token keyword\">void</span> <span class=\"token function\">PBKDF2</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> FunctionCallbackInfo<span class=\"token operator\">&lt;</span>Value<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">auto</span> rv <span class=\"token operator\">=</span> args<span class=\"token punctuation\">.</span><span class=\"token function\">GetReturnValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Environment<span class=\"token operator\">*</span> env <span class=\"token operator\">=</span> Environment<span class=\"token operator\">::</span><span class=\"token function\">GetCurrent</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">CHECK</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">IsArrayBufferView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// keybuf; wrap object retains ref.</span>\n  <span class=\"token function\">CHECK</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">IsArrayBufferView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// pass</span>\n  <span class=\"token function\">CHECK</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">IsArrayBufferView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// salt</span>\n  <span class=\"token function\">CHECK</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">IsUint32</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// iteration_count</span>\n  <span class=\"token function\">CHECK</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">IsString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// digest_name</span>\n  <span class=\"token function\">CHECK</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">IsObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">IsUndefined</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// wrap object</span>\n  std<span class=\"token operator\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>PBKDF2Job<span class=\"token operator\">></span> <span class=\"token function\">job</span><span class=\"token punctuation\">(</span>new <span class=\"token function\">PBKDF2Job</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">//SOME MORE C++ CODE...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// C++ 함수를 자바스크립트에서 사용할 수 있도록 export</span>\nenv<span class=\"token operator\">-></span><span class=\"token function\">SetMethod</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> <span class=\"token string\">\"pbkdf2\"</span><span class=\"token punctuation\">,</span> PBKDF2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그리고 이 C++파일에서는 V8 엔진의 코드와 libuv의 코드도 실행되고 있는 것을 확인해 볼 수 있다. uv로 시작되는 변수 또는 함수가 libuv 코드이다.(<code class=\"language-text\">uv_once</code>)</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">using v8<span class=\"token operator\">::</span>Array<span class=\"token punctuation\">;</span>\nusing v8<span class=\"token operator\">::</span>ArrayBufferView<span class=\"token punctuation\">;</span>\nusing v8<span class=\"token operator\">::</span>Boolean<span class=\"token punctuation\">;</span>\nusing v8<span class=\"token operator\">::</span>ConstructorBehavior<span class=\"token punctuation\">;</span>\nusing v8<span class=\"token operator\">::</span>Context<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//...</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">Initialize</span><span class=\"token punctuation\">(</span>Local<span class=\"token operator\">&lt;</span>Object<span class=\"token operator\">></span> target<span class=\"token punctuation\">,</span>\n                Local<span class=\"token operator\">&lt;</span>Value<span class=\"token operator\">></span> unused<span class=\"token punctuation\">,</span>\n                Local<span class=\"token operator\">&lt;</span>Context<span class=\"token operator\">></span> context<span class=\"token punctuation\">,</span>\n                <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> priv<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">static</span> uv_once_t init_once <span class=\"token operator\">=</span> UV_ONCE_INIT<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">uv_once</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>init_once<span class=\"token punctuation\">,</span> InitCryptoOnce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//...</span></code></pre></div>\n<br>\n<p>이 과정을 그림으로 정리해보면 다음과 같다. 아래의 그림 자료가 최신의 자료는 아니라서 바인딩 함수가 약간 다르다. 위의 코드에서는 <code class=\"language-text\">internalBinding</code> 함수를 통해 바인딩 하지만 아래의 자료에서는 <code class=\"language-text\">process.binding()</code>으로 바인딩을 한다. nodejs가 업데이트되면서 바인딩 함수도 새로 작성된 것이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 751px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a8f3e6d291c588be4b1b9849b2c22e3f/e7069/nodejs_module_implementations.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.254327563249%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAACJElEQVQoz32SWW/aUBCF8/9/SB/6WqVKlKQJS7MWCJjNeMHGgBfwAo7j4Nj+erGatERtR7rS+HrumZlzzlFZlpRFSZ7n7MOOFnSnHertK5qPda57TRqPNeqdWnUnmV38eFXVVm8/nCM+xGrjozszZFNFW5p0xj06slTliqVjeBab5+2/AYMgxDRFsaKyXMyZrTIG81dOGkPObmTObxW+1iROGwPqLVHngRtmeziK4i+AeV6QJAmWNWfteTjhC6qTct/Tue9qXLcn1O76tAcGD5KBIRrGu8Ot/rty8YvLZ2XM7PIM7eIU9fyE+dUFT7rCwraZyDK6PmW5tHEdlyzL3oGP3pCLoqjEqb7Fz0SsH8ojrNYDVvsH4XhIvFwQbbaCmiXr9boScrfbVYDvEx4Alr8nzTQZRj3s5iX+XROEOE/aBNt10DVNTKgjj2U0VcNzvfdhKsA/103SHcmuJPYjnjwfc6wwV6Ykq4A4jPE3z6zWIo9joigiTdMDHoXKgVBYYTgYYs0MYZmUjvnCt/aMT8c3HH+X+dIY8fm0RXPgIgkHeNvikHex3RtllSj7LmEYEoUB6+2r8FrKaOpVpzdZ0BpMGYt8oNlYfiZ8mPOvOFi56hYZ4EkQCA63Gu6owUa/E7mKUEk4v0/qm3grX3Dn4giVbdvBFXngBx9EEYB5oJPbHXJHonAlQvWWxGxV+f6udLoC0GAlONU1nb7Ur+iyhZ32vP4EA9aGSfaUTgIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/a8f3e6d291c588be4b1b9849b2c22e3f/01472/nodejs_module_implementations.webp 240w,\n/static/a8f3e6d291c588be4b1b9849b2c22e3f/222bd/nodejs_module_implementations.webp 480w,\n/static/a8f3e6d291c588be4b1b9849b2c22e3f/04ded/nodejs_module_implementations.webp 751w\"\n          sizes=\"(max-width: 751px) 100vw, 751px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/a8f3e6d291c588be4b1b9849b2c22e3f/0783d/nodejs_module_implementations.png 240w,\n/static/a8f3e6d291c588be4b1b9849b2c22e3f/782f4/nodejs_module_implementations.png 480w,\n/static/a8f3e6d291c588be4b1b9849b2c22e3f/e7069/nodejs_module_implementations.png 751w\"\n          sizes=\"(max-width: 751px) 100vw, 751px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/a8f3e6d291c588be4b1b9849b2c22e3f/e7069/nodejs_module_implementations.png\"\n          alt=\"nodejs module implementation\"\n          title=\"nodejs module implementation\"\n          loading=\"lazy\"\n        />\n      </picture>\n  </a>\n    </span></p>","fields":{"slug":"/nodejs/module-implementation","tagSlugs":["/tag/nodejs/"]},"frontmatter":{"date":"2020-01-04T17:10:37.121Z","description":"Nodejs 서버를 만들 때 crypto nodejs 라이브러리의 pbkdf2 함수를 실행시키면 nodejs 내부적으로 어떤 일이 일어나는지를 정리해본다. ","tags":["nodejs"],"title":"Nodejs 모듈이 구현되는 방법","socialImage":"/media/image-2.jpg"}}},"pageContext":{"slug":"/nodejs/module-implementation"}},"staticQueryHashes":["251939775","3439816877","401334301"]}